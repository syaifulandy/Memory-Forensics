#!/bin/bash

# === Mulai waktu eksekusi ===
start_time=$(date +%s)
echo "[*] Mulai pada: $(date)"

# === Input lokasi memory dump ===
memory_path="$1"

if [ -z "$memory_path" ]; then
    echo "[!] Usage: $0 <path_to_memory_dump>"
    exit 1
fi

# === Ambil nama file untuk penamaan folder output ===
memory_file=$(basename "$memory_path")
memory_name="$memory_file"
output_folder="output_${memory_name}"
dump_folder="/opt/forensic_tools/volatility/dump_memory_${memory_name}"
report_file="Report_scan_dump_memory_${memory_name}.txt"

# === Langkah 1: Ekstraksi data Volatility ===
echo "[*] Menjalankan step 1: Ekstraksi data dengan Volatility"
bash /opt/forensic_tools/volatility/1.runvol_extract_data.sh "$memory_path"

# === Langkah 2: Analisis proses ===
echo "[*] Menjalankan step 2: Analisis proses"
psscan_file="${output_folder}/windows_psscan_${memory_name}.txt"
pstree_file="${output_folder}/windows_pstree_${memory_name}.txt"
bash /opt/forensic_tools/volatility/5.process_analysis.sh -p "$psscan_file" -t "$pstree_file"

# === Langkah 3: Dump file memory ===
echo "[*] Menjalankan step 3: Dump file dari memory"
bash /opt/forensic_tools/volatility/6.dump_files.sh "$memory_path" normal

# === Langkah 4: Scan dengan YARA ===
echo "[*] Menjalankan step 4: Scan YARA"
bash /opt/forensic_tools/yara/runcompiledyara.sh "$dump_folder"

# === Langkah 5: Submit ke VirusTotal / Analisis lanjut ===
echo "[*] Menjalankan step 5: Analisis hasil YARA"
bash /opt/forensic_tools/yara/virtot.sh "$report_file"

# === Akhiri waktu eksekusi ===
end_time=$(date +%s)
duration=$((end_time - start_time))

# === Tampilkan hasil waktu ===
echo "[*] Selesai pada: $(date)"
echo "[*] Total waktu eksekusi: $duration detik ($((duration / 60)) menit $((duration % 60)) detik)"

